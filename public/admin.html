<!DOCTYPE html>
<html>

<head>
<title>Geopardy</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>


<style>
    #map { height: 700px; }
</style>


</head>
<body>
    <h1 style="text-align:center;">Results</h1>
    <input type="button" id="btnFetch" value="Fetch">
    <input type="button" id="btnReset" value="Reset">
    <input type="text" id="anchorTxt">
    <input type="button" id="anchorBtn" value="Set">
    <p id="win"></p>



    <div id="map"></div>
</body>
<script>

var map = L.map('map').setView([47.567, 9.671], 3);
const out1 = document.getElementById('output');
const btnFetch = document.getElementById('btnFetch')
const btnReset = document.getElementById('btnReset')
const anchorTxt = document.getElementById('anchorTxt')
const acnhorBtn = document.getElementById('anchorBtn')
const win = document.getElementById('win')
var markers = []
var lines = []
var anchor
var winner

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);



btnFetch.addEventListener('click', pullMarkers);
btnReset.addEventListener('click', resetMarkersDB)
acnhorBtn.addEventListener('click', setAnchor)


function setAnchor(){
    if(!anchorTxt.value == ''){
        if(anchor){
            anchor.remove()
        }
        var splitT = anchorTxt.value.split(',')
        anchor = new L.marker([splitT[0],splitT[1]],{icon: donIcon}).addTo(map)
    }
}









var baseUrl = 'http://localhost:10000/'
async function pullMarkers(e){

    if(!anchor){
        return
    }

    e.preventDefault();

    const res = await fetch(baseUrl+'fetch', {
        method: 'GET'
        
            
    })

    
    const data = await res.json()
    
    removeAllMarkers()
    makeMarkers(data)


    


}

async function resetMarkersDB(e){
    e.preventDefault();

    const res = await fetch(baseUrl+'reset', {
        method: 'GET'
        
            
    })

    removeAllMarkers()
}

function removeAllMarkers(){
    win.innerHTML=''
    winner = null
    for(let i=0;i<markers.length;i++){
        markers[i].remove();
    }

    for(let i=0;i<lines.length;i++){
        lines[i].remove();
    }
}

function makeMarkers(arrayData){
    var len = arrayData['length']

    for(let i=0;i<len;i++){
        var currLoc = buildLoc(arrayData[i])

        var marker = new L.marker([currLoc.llat,currLoc.llng]).addTo(map)
        

        var dist = map.distance(anchor.getLatLng(),marker.getLatLng())
        var distStr = Math.trunc(dist)/1000 + 'km'

        if(!winner){
            winner = {name:currLoc.lname, distanz:dist}
        }else if(dist < winner.distanz){
            winner = {name:currLoc.lname, distanz:dist}
        }

        marker.bindPopup(currLoc.lname + '\n'+distStr)

        markers.push(marker)

        var pl = L.polyline([anchor.getLatLng(), marker.getLatLng()]).addTo(map)
        lines.push(pl)

    }

    win.innerHTML = 'Sieg: '+winner.name



}

function buildLoc(retString){

var compString = retString.replaceAll(' ','')
var name = compString.split(':')[0]
var lalo = compString.split(':')[1].split(',')
var lat = lalo[0]
var lng = lalo[1]

return {lname:name,llat:lat,llng:lng}


}

var donIcon = L.icon({
    iconUrl: 'map-marker.png',
    shadowUrl: '',

    iconSize:     [30, 47], 
    shadowSize:   [50, 64], 
    iconAnchor:   [15, 50], 
    shadowAnchor: [4, 62],  
    popupAnchor:  [-3, -76] 
});

</script>


</html>